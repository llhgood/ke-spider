name: Build macOS Executable for Ke.com Spider

on:
  push:
    tags:
      - 'v*' # 推送v开头的tag时触发构建，例如 v1.0
  workflow_dispatch: # 允许手动触发工作流

jobs:
  build-macos:
    runs-on: macos-latest # 使用macOS最新版本的运行器

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pandas openpyxl

    - name: Create cookies.txt (placeholder)
      run: |
        # 这里需要您手动处理cookies
        # 方法1: 将真实的cookies.txt内容设置为secret，然后在这里写入
        # 方法2: 在运行前手动准备好cookies.txt文件并提交到仓库
        if [ ! -f cookies.txt ]; then
          echo "请确保cookies.txt文件存在" > cookies.txt
          echo "您需要将真实的cookies内容放入此文件" >> cookies.txt
        fi

    - name: Create test Excel file (placeholder)
      run: |
        # 创建测试用的Excel文件，您应该使用真实的数据文件
        if [ ! -f '0903 测试 房源.xlsx' ]; then
          python -c "
          import pandas as pd
          df = pd.DataFrame({'楼盘名称': ['恒大御景湾', '测试小区1', '测试小区2']})
          df.to_excel('0903 测试 房源.xlsx', index=False)
          "
        fi

    - name: Build with PyInstaller
      run: |
        # 使用PyInstaller打包，替换your_script_name.py为您的实际文件名
        pyinstaller --onefile --name ke-spider-macos \
          --add-data "cookies.txt:." \
          --add-data "0903 测试 房源.xlsx:." \
          --hidden-import=pandas._libs.tslibs.timedeltas \
          --hidden-import=pandas._libs.tslibs.nattype \
          --hidden-import=pandas._libs.tslibs.base \
          --hidden-import=curl_cffi \
          --hidden-import=bs4 \
          your_script_name.py

    - name: Test the executable
      run: |
        # 测试生成的可执行文件是否能运行
        ./dist/ke-spider-macos --help || echo "可执行文件测试运行（可能需要实际参数）"

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ke-spider-macos-executable
        path: |
          dist/ke-spider-macos
          cookies.txt
          0903 测试 房源.xlsx
        if-no-files-found: error

    - name: Show workflow info
      run: |
        echo "构建完成！请在Artifacts中下载 ke-spider-macos-executable"
        echo "下载后，请确保以下文件在同一目录："
        echo "1. ke-spider-macos (可执行文件)"
        echo "2. cookies.txt (需要替换为真实的cookies文件)"
        echo "3. 0903 测试 房源.xlsx (您的数据文件)"
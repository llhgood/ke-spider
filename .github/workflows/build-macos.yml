name: Build macOS Executable for Ke.com Spider

on:
  push:
    tags:
      - 'v*' # 推送v开头的tag时触发构建，例如 v1.0
  workflow_dispatch: # 允许手动触发工作流

jobs:
  build-macos:
    runs-on: macos-latest # 使用macOS最新版本的运行器

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pandas openpyxl

    - name: Create placeholder files for build
      run: |
        # 创建必要的占位文件用于构建
        if [ ! -f cookies.txt ]; then
          echo "# 请在使用前替换为真实的cookies内容" > cookies.txt
          echo "# 安全提示：不要将真实cookies提交到版本控制" >> cookies.txt
        fi
        
        if [ ! -f '0903 测试 房源.xlsx' ]; then
          python -c "
          import pandas as pd
          df = pd.DataFrame({'楼盘名称': ['恒大御景湾', '测试小区1', '测试小区2']})
          df.to_excel('0903 测试 房源.xlsx', index=False)
          print('已创建测试Excel文件')
          "
        fi

    - name: Build with PyInstaller
      run: |
        # 使用PyInstaller打包，替换your_script_name.py为您的实际文件名
        pyinstaller --onefile --name ke-spider-macos \
          --add-data "cookies.txt:." \
          --add-data "0903 测试 房源.xlsx:." \
          --hidden-import=pandas._libs.tslibs.timedeltas \
          --hidden-import=pandas._libs.tslibs.nattype \
          --hidden-import=pandas._libs.tslibs.base \
          --hidden-import=curl_cffi \
          --hidden-import=bs4 \
          your_script_name.py

    - name: Create output directory with all required files
      run: |
        # 创建包含所有必需文件的输出目录
        mkdir -p dist-package
        cp dist/ke-spider-macos dist-package/
        cp cookies.txt dist-package/
        cp '0903 测试 房源.xlsx' dist-package/
        
        # 创建使用说明文件
        echo "# 使用说明" > dist-package/README.txt
        echo "1. 确保以下文件在同一目录：" >> dist-package/README.txt
        echo "   - ke-spider-macos (可执行文件)" >> dist-package/README.txt
        echo "   - cookies.txt (需要替换为真实的cookies)" >> dist-package/README.txt
        echo "   - 0903 测试 房源.xlsx (数据文件)" >> dist-package/README.txt
        echo "2. 给可执行文件添加运行权限: chmod +x ke-spider-macos" >> dist-package/README.txt
        echo "3. 运行: ./ke-spider-macos" >> dist-package/README.txt

    - name: Upload artifact using v4
      uses: actions/upload-artifact@v4
      with:
        name: ke-spider-macos-package
        path: dist-package/
        if-no-files-found: error
        retention-days: 7

    - name: Show success message
      run: |
        echo "✅ 构建成功完成！"
        echo "📦 请在Artifacts中下载 ke-spider-macos-package"
        echo "🔧 下载后请参考README.txt文件中的使用说明"
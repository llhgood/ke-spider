name: Build macOS Executable for Ke.com Spider

on:
  push:
    tags:
      - 'v*' # æ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘æ„å»ºï¼Œä¾‹å¦‚ v1.0
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  build-macos:
    runs-on: macos-latest # ä½¿ç”¨macOSæœ€æ–°ç‰ˆæœ¬çš„è¿è¡Œå™¨

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pandas openpyxl

    - name: Create placeholder files for build
      run: |
        # åˆ›å»ºå¿…è¦çš„å ä½æ–‡ä»¶ç”¨äºæ„å»º
        if [ ! -f cookies.txt ]; then
          echo "# è¯·åœ¨ä½¿ç”¨å‰æ›¿æ¢ä¸ºçœŸå®çš„cookieså†…å®¹" > cookies.txt
          echo "# å®‰å…¨æç¤ºï¼šä¸è¦å°†çœŸå®cookiesæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶" >> cookies.txt
        fi
        
        if [ ! -f '0903 æµ‹è¯• æˆ¿æº.xlsx' ]; then
          python -c "
          import pandas as pd
          df = pd.DataFrame({'æ¥¼ç›˜åç§°': ['æ’å¤§å¾¡æ™¯æ¹¾', 'æµ‹è¯•å°åŒº1', 'æµ‹è¯•å°åŒº2']})
          df.to_excel('0903 æµ‹è¯• æˆ¿æº.xlsx', index=False)
          print('å·²åˆ›å»ºæµ‹è¯•Excelæ–‡ä»¶')
          "
        fi

    - name: Build with PyInstaller
      run: |
        # ä½¿ç”¨PyInstalleræ‰“åŒ…ï¼Œæ›¿æ¢your_script_name.pyä¸ºæ‚¨çš„å®é™…æ–‡ä»¶å
        pyinstaller --onefile --name ke-spider-macos \
          --add-data "cookies.txt:." \
          --add-data "0903 æµ‹è¯• æˆ¿æº.xlsx:." \
          --hidden-import=pandas._libs.tslibs.timedeltas \
          --hidden-import=pandas._libs.tslibs.nattype \
          --hidden-import=pandas._libs.tslibs.base \
          --hidden-import=curl_cffi \
          --hidden-import=bs4 \
          your_script_name.py

    - name: Create output directory with all required files
      run: |
        # åˆ›å»ºåŒ…å«æ‰€æœ‰å¿…éœ€æ–‡ä»¶çš„è¾“å‡ºç›®å½•
        mkdir -p dist-package
        cp dist/ke-spider-macos dist-package/
        cp cookies.txt dist-package/
        cp '0903 æµ‹è¯• æˆ¿æº.xlsx' dist-package/
        
        # åˆ›å»ºä½¿ç”¨è¯´æ˜æ–‡ä»¶
        echo "# ä½¿ç”¨è¯´æ˜" > dist-package/README.txt
        echo "1. ç¡®ä¿ä»¥ä¸‹æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ï¼š" >> dist-package/README.txt
        echo "   - ke-spider-macos (å¯æ‰§è¡Œæ–‡ä»¶)" >> dist-package/README.txt
        echo "   - cookies.txt (éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„cookies)" >> dist-package/README.txt
        echo "   - 0903 æµ‹è¯• æˆ¿æº.xlsx (æ•°æ®æ–‡ä»¶)" >> dist-package/README.txt
        echo "2. ç»™å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ è¿è¡Œæƒé™: chmod +x ke-spider-macos" >> dist-package/README.txt
        echo "3. è¿è¡Œ: ./ke-spider-macos" >> dist-package/README.txt

    - name: Upload artifact using v4
      uses: actions/upload-artifact@v4
      with:
        name: ke-spider-macos-package
        path: dist-package/
        if-no-files-found: error
        retention-days: 7

    - name: Show success message
      run: |
        echo "âœ… æ„å»ºæˆåŠŸå®Œæˆï¼"
        echo "ğŸ“¦ è¯·åœ¨Artifactsä¸­ä¸‹è½½ ke-spider-macos-package"
        echo "ğŸ”§ ä¸‹è½½åè¯·å‚è€ƒREADME.txtæ–‡ä»¶ä¸­çš„ä½¿ç”¨è¯´æ˜"